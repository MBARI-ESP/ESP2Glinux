#!/bin/sh
#
#  ifdown [interface name]
#

IFNAME=$1
resolv=/etc/resolv.conf
oldHostname=/var/run/oldHostname.$IFNAME
oldHosts=/var/run/oldHosts.$IFNAME
peerName=/var/run/peername.$IFNAME


usage ()
{
    echo "usage:  ifdown [netInterface]"
    echo "  deconfigure and disable the specified network interface"
    exit 1
}


ifAliasDown() {
  echo "Shutting down interface $1 ..."
  fn=/var/run/*$1.pid
  pidfns=`echo $fn`
  [ "$pidfns" = "$fn" ] || for pidfn in $pidfns; do
    kill `cat $pidfn` 2>/dev/null
  done
  ifconfig $1 down 2>/dev/null


  #Following ~12 lines moved from /etc/ppp/ip-down, 2jun2006, rah
  if [ "`head -1 $resolv`" = "#$1" ]; then
    > $resolv
    [ -r $oldHosts ] && cp $oldHosts /etc/hosts
  fi

  if [ -r $oldHostname ]; then
    #revert to old name
    [ "`cat $peerName`" = "`hostname`" ] && hostname -F $oldHostname
  fi

  rm $oldHostname $oldHosts $peerName
  
}

eachAlias() {
  cfg=/etc/sysconfig/ifcfg-
  aliases=`echo $cfg$2:*`
  [ "$aliases" = $cfg$2:\* ] || {
    for alias in $aliases; do
       $1 ${alias#$cfg}
    done
  }
}


case "$1" in
  -*|*/*|'') #any flag is a request for help
    usage    
  ;;
  
  *) #anything else must be the name of an interface or alias
    if [ "$1" = "${1%:*}" ]; then  #if not an alias
      eachAlias ifAliasDown $1
      ifAliasDown $1
    else
      ifAliasDown $1
    fi
  ;;
esac
