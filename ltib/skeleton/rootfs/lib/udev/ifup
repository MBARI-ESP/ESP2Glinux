#!/usr/bin/setsid /bin/sh
#setsid because udev requires blocking processes to detach
#first argument the name of a newly detected network interface
#optional 2nd argument is start up (sleep) delay
#when $lockFn exists, actions are deferred
#otherwise, this brings interface UP if it was down
exec 7<&- 5<&- >>/dev/console 2>&1

iface=$1
case $iface in
  eth*|wlan*)  delay=$2
;;
  *) delay=${2:-20}  #default delay for modems
esac 
lockFn=/run/ifup.pending  #must be empty before udevd starts
[ -r $lockFn ] && {
  exec 7<$lockFn  #acquire lock
  flock -x 7 && [ -e $lockFn ] && { #got lock, so defer ifup
    [ "$delay" ] || exec echo -n "$iface " >>$lockFn  #no start delay
    IFS=. read now idle </proc/uptime  #uptime in secs
    let "start=now+$delay"  #interface's deferred start time
    exec echo -n "$start $iface " >>$lockFn
  }
  exec 7<&-       #release lock.  Did not need to defer ifup.  ifup now!
}
. /usr/share/netutils.sh
ifCfg $iface
ifUpAuto $delay &

#catchup command starts interfaces listed in ifup.pending
