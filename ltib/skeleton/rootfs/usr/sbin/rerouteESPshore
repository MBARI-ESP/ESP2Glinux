#!/bin/sh
prog=`basename $0`

case "$1" in
  )
;;
  *) cat >&2 <<END
Reroute traffic to ESPshore -- 2/12/25 brent@mbari.org
Select different route to ESPshore wireguard server
Intended to be invoked from wgatch
Usage:
  $prog
END
  exit 2
esac

. /usr/share/netutils.sh

USBportOn() {
  return 1
}
USBportOff() {
  :
}

type ykushcmd 2>/dev/null && {
  USBportOn() {  #$1=port#
    ykushcmd -u $1
  }
  USBportOff() {
    ykushcmd -d $1
  }
}

bringDown() {
#bring down specified $1=interface, $2=USB port #
  ifdown $1
  [ "$2" ] && USBportOff $2
}

bringUp() {
#bring up specified $1=interface, $2=USB port #, $3=delay
  [ "$2" ] && {
    USBportOn $2 && {
      [ "$3" ] || return 0  #if no delay, assume udev rule will bring iface up
    }
    sleep $3
  }
  ifup $1 ||
    logger -t $prog -p daemon.warning "Failed to bring up $1"
}

bringUpCell() {
#$1=optional delay before re-starting sat
  if [ "$cellIface" ]; then
    bringUp "$cellIface" "$cellUSBport" "$cellDelay"
  else
    [ "$1" ] && sleep $1
    bringUp "$satIface" "$satUSBport" "$satDelay"
  fi
}
bringUpSat() {
#$1=optional delay before re-starting cell
  if [ "$satIface" ]; then
    bringUp "$satIface" "$satUSBport" "$satDelay"
  else
    [ "$1" ] && sleep $1
    bringup  "$cellIface" "$cellUSBport" "$cellDelay"
  fi
}

bringDownCell() {
  bringDown "$cellIface" "$cellUSBport"
}
bringDownSat() {
  bringDown "$satIface" "$satUSBport"
}


: ${traceFn:=/var/run/trace/$prog}
[ -w $traceFn ] && {
  { date; echo "$@"; env; } >>$traceFn
  exec 2>>$traceFn
  set -x
}

case "`routeTo $ESPshore 2>/dev/null`" in
  )
    bringUpCell
;;

  $cellIface)
    bringDownCell
    bringUpSat 9
;;

  $satIface)
    bringDownSat
    bringUpCell 30
;;

  *) #if another route has higher priority, create a specific route to ESPshore
    if isUp $cellIface; then
      ip route replace $ESPshore dev $cellIface
    elif isUp $satIface
      ip route replace $ESPshore dev $satIface
    else
      bringUpCell
    fi
esac
